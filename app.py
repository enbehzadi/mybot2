from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
import requests
import os
import logging

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
if not TOKEN:
    logger.error("Error: Telegram bot token is missing!")
    exit(1)

# Ø¢Ø¯Ø±Ø³ API
API_URL = os.getenv('API_URL', 'https://web-production-445f.up.railway.app/messages')

# Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ù†Ùˆ
def get_menu_keyboard():
    return ReplyKeyboardMarkup(
        [
            ["Send Emergency Message"],
            ["About Me", "My Resume"],
            ["Contact Me"]
        ],
        resize_keyboard=True  # Ú©ÙˆÚ†Ú© Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
    )

# Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ API
async def send_to_api(user, message_text):
    message_data = {
        'telegram_id': user.id,
        'first_name': user.first_name,
        'last_name': user.last_name if user.last_name else "",
        'message_text': message_text
    }

    try:
        response = requests.post(API_URL, json=message_data)
        if response.status_code == 201:
            logger.info(f"Message saved: {message_text}")
        else:
            logger.error(f"API Error: {response.status_code} - {response.text}")
    except Exception as e:
        logger.error(f"Error sending message to API: {e}")

# Ø¯Ø³ØªÙˆØ± /start
async def start(update: Update, context: CallbackContext):
    user = update.message.from_user
    # Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø³ØªØ§Ø±Øª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù¾ÛŒØ§Ù…
    await send_to_api(user, "Start")

    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! Ù„Ø·ÙØ§ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ø² Ù…Ù†Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=get_menu_keyboard()
    )

# Ø¯Ø³ØªÙˆØ± /menu
async def menu(update: Update, context: CallbackContext):
    await update.message.reply_text(
        "Ù…Ù†Ùˆ:",
        reply_markup=get_menu_keyboard()
    )

# Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ
async def handle_menu(update: Update, context: CallbackContext):
    text = update.message.text
    user = update.message.from_user

    # Ø°Ø®ÛŒØ±Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± API
    await send_to_api(user, text)

    if text == "Send Emergency Message":
        await update.message.reply_text("Ù„Ø·ÙØ§ Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        context.user_data['waiting_for_emergency_message'] = True
    elif text == "About Me":
        about_me = """
        Ù…Ù† ÛŒÚ© ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù‡Ø³ØªÙ… Ú©Ù‡ Ø¹Ø§Ø´Ù‚ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø² Ù‡Ø³ØªÙ….
        Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯Ù… Ùˆ Ø¹Ø§Ø´Ù‚ Ø²Ø¨Ø§Ù† ØªØ±Ú©ÛŒ Ù‡Ø³ØªÙ….
        """
        await update.message.reply_text(about_me)
    elif text == "My Resume":
        resume_link = "https://enbehzadi.github.io/resume"  # Ù„ÛŒÙ†Ú© Ø±Ø²ÙˆÙ…Ù‡ Ø´Ù…Ø§
        await update.message.reply_text(f"Ø±Ø²ÙˆÙ…Ù‡ Ù…Ù† Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\n{resume_link}")
    elif text == "Contact Me":
        contact_info = """
        Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:
        ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: enbehzadi@gmail.com
        ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: +989158059590
        """
        await update.message.reply_text(contact_info)
    else:
        await update.message.reply_text("Ù„Ø·ÙØ§ Ø§Ø² Ù…Ù†Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.")

# Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ
async def handle_emergency_message(update: Update, context: CallbackContext):
    if context.user_data.get('waiting_for_emergency_message', False):
        text = update.message.text
        user = update.message.from_user

        # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø¯Ø± API
        await send_to_api(user, f"Emergency Message: {text}")

        await update.message.reply_text("Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…")
        # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª
        context.user_data['waiting_for_emergency_message'] = False
    else:
        await update.message.reply_text("Ù„Ø·ÙØ§ Ø§Ø² Ù…Ù†Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.")

# ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
def main():
    application = Application.builder().token(TOKEN).build()

    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("menu", menu))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_emergency_message))

    # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
    application.run_polling()

if __name__ == '__main__':
    main()
